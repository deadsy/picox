//-----------------------------------------------------------------------------
/*

Look Up Tables

*/
//-----------------------------------------------------------------------------

#include "picox.h"


//-----------------------------------------------------------------------------

int32_t __SMMLA(  int32_t x,  int32_t y,  int32_t sum)  {
    return (sum + (int32_t) (((int64_t) x * y) >> 32));
  }

int64_t mul64(uint32_t a, uint32_t b) {

  uint16_t ah = a >> 16;
  uint16_t al = a;

  uint16_t bh = b >> 16;
  uint16_t bl = b;

  uint64_t p0 = ah * bh;
  uint64_t p1 = ah * bl;
  uint64_t p2 = al * bh;
  uint64_t p3 = al * bl;

  return (p0 << 32) + (p1 << 16) + (p2 << 16) + p3;
}

//-----------------------------------------------------------------------------
// linear interpolation

static inline int32_t lerp(const int32_t * lut, uint32_t x, int s0, int s1) {
	uint32_t idx = x >> s0;
	int32_t frac = x & ((1 << s0) - 1);
	int32_t y0 = lut[idx];
	int32_t y1 = lut[idx + 1];
	return y0 + (((y1 - y0) * (frac >> s1)) >> (s0 - s1));
}

//-----------------------------------------------------------------------------
// LUT based Cosine, generated by ./tools/cos_lut.py

#define COS_LUT_BITS (7U)
#define COS_LUT_SIZE (1U << COS_LUT_BITS)

static const int32_t COS_LUT_data[COS_LUT_SIZE + 1] = {
        2147483647, 2144896909, 2137142927, 2124240380, 2106220351, 2083126254, 2055013723, 2021950483,
        1984016188, 1941302224, 1893911494, 1841958164, 1785567396, 1724875039, 1660027308, 1591180425,
        1518500249, 1442161874, 1362349204, 1279254515, 1193077990, 1104027236, 1012316784, 918167571,
        821806413, 723465451, 623381597, 521795963, 418953276, 315101294, 210490206, 105372028,
        0, -105372028, -210490206, -315101294, -418953276, -521795963, -623381597, -723465451,
        -821806413, -918167571, -1012316784, -1104027236, -1193077990, -1279254515, -1362349204, -1442161874,
        -1518500249, -1591180425, -1660027308, -1724875039, -1785567396, -1841958164, -1893911494, -1941302224,
        -1984016188, -2021950483, -2055013723, -2083126254, -2106220351, -2124240380, -2137142927, -2144896909,
        -2147483648, -2144896909, -2137142927, -2124240380, -2106220351, -2083126254, -2055013723, -2021950483,
        -1984016188, -1941302224, -1893911494, -1841958164, -1785567396, -1724875039, -1660027308, -1591180425,
        -1518500249, -1442161874, -1362349204, -1279254515, -1193077990, -1104027236, -1012316784, -918167571,
        -821806413, -723465451, -623381597, -521795963, -418953276, -315101294, -210490206, -105372028,
        0, 105372028, 210490206, 315101294, 418953276, 521795963, 623381597, 723465451,
        821806413, 918167571, 1012316784, 1104027236, 1193077990, 1279254515, 1362349204, 1442161874,
        1518500249, 1591180425, 1660027308, 1724875039, 1785567396, 1841958164, 1893911494, 1941302224,
        1984016188, 2021950483, 2055013723, 2083126254, 2106220351, 2124240380, 2137142927, 2144896909,
        2147483647,
};

q31 cos_lut(uint32_t x) {
	return lerp(COS_LUT_data, x, 32 - COS_LUT_BITS, 21);
}

//-----------------------------------------------------------------------------

q17 m2f_lut(q24 note) {
  (void)note;
  return 0;
}

//-----------------------------------------------------------------------------
// LUT based Power of 2

static const uint16_t exp0_table[64] = {
	0x8000, 0x8165, 0x82ce, 0x843a, 0x85ab, 0x871f, 0x8898, 0x8a15, 0x8b96, 0x8d1b, 0x8ea4, 0x9032, 0x91c4, 0x935a, 0x94f5, 0x9694,
	0x9838, 0x99e0, 0x9b8d, 0x9d3f, 0x9ef5, 0xa0b0, 0xa270, 0xa435, 0xa5ff, 0xa7ce, 0xa9a1, 0xab7a, 0xad58, 0xaf3b, 0xb124, 0xb312,
	0xb505, 0xb6fe, 0xb8fc, 0xbaff, 0xbd09, 0xbf18, 0xc12c, 0xc347, 0xc567, 0xc78d, 0xc9ba, 0xcbec, 0xce25, 0xd063, 0xd2a8, 0xd4f3,
	0xd745, 0xd99d, 0xdbfc, 0xde61, 0xe0cd, 0xe340, 0xe5b9, 0xe839, 0xeac1, 0xed4f, 0xefe5, 0xf281, 0xf525, 0xf7d1, 0xfa84, 0xfd3e,
};

static const uint16_t exp1_table[64] = {
	0x8000, 0x8006, 0x800b, 0x8011, 0x8016, 0x801c, 0x8021, 0x8027, 0x802c, 0x8032, 0x8037, 0x803d, 0x8043, 0x8048, 0x804e, 0x8053,
	0x8059, 0x805e, 0x8064, 0x806a, 0x806f, 0x8075, 0x807a, 0x8080, 0x8085, 0x808b, 0x8090, 0x8096, 0x809c, 0x80a1, 0x80a7, 0x80ac,
	0x80b2, 0x80b8, 0x80bd, 0x80c3, 0x80c8, 0x80ce, 0x80d3, 0x80d9, 0x80df, 0x80e4, 0x80ea, 0x80ef, 0x80f5, 0x80fa, 0x8100, 0x8106,
	0x810b, 0x8111, 0x8116, 0x811c, 0x8122, 0x8127, 0x812d, 0x8132, 0x8138, 0x813e, 0x8143, 0x8149, 0x814e, 0x8154, 0x815a, 0x815f,
};

// pow2_lut returns 2^x where x = [0,1)
q30 pow2_lut(q31 x) {
	// we need 12 bits of fraction
	x >>= 19;
	uint16_t x0 = exp0_table[(x >> 6) & 0x3f];
	uint16_t x1 = exp1_table[x & 0x3f];
	return x0 * x1;
}

//-----------------------------------------------------------------------------
